<section class="admin-container">
  <h1>Digest Campaigns</h1>

  {{#if this.error}}
    <div class="alert alert-error">{{this.error}}</div>
  {{/if}}

  {{#if this.notice}}
    <div class="alert alert-success">{{this.notice}}</div>
  {{/if}}

  <div style="margin: 10px 0;">
    <button class="btn btn-primary" {{on "click" this.refreshNow}} disabled={{this.busy}}>
      Refresh
    </button>
  </div>

  <hr>

  <h2>Create Campaign</h2>

  <div class="form-horizontal">
    <div class="control-group">
      <label class="control-label">campaign_key</label>
      <div class="controls">
        <Input @value={{this.campaign_key}} class="input-xxlarge" placeholder="blast_2026_02_23" />
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">selection_sql (returns user_id)</label>
      <div class="controls">
        <Textarea
          @value={{this.selection_sql}}
          class="input-xxlarge"
          rows="6"
          placeholder="SELECT u.id AS user_id FROM users u WHERE u.active = true"
        />

        <div style="margin-top:6px;">
          <button class="btn" {{on "click" this.countDraftRecords}} disabled={{this.busy}}>
            Count records
          </button>

          {{#if (not (eq this.draftCount null))}}
            <span style="margin-left:10px;">
              <strong>{{this.draftCount}}</strong> record(s)
            </span>
          {{/if}}
        </div>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">exclude recent queue users</label>
      <div class="controls">
        <label class="checkbox" style="display:block;">
          <Input @type="checkbox" @checked={{this.exclude_recent_from_queue}} />
          Exclude users with queue records from the last
          <Input @value={{this.exclude_recent_from_queue_days}} @type="number" class="input-small" min="0" step="1" style="margin:0 6px;" />
          day(s)
        </label>
        <div class="help-block">
          Regular (non-delayed) queue rows are excluded if they were enqueued in the timeframe. Delayed-send rows are excluded only if they were actually sent in the timeframe.
        </div>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">topic_set_1</label>
      <div class="controls">
        <Input @value={{this.topic_set_1}} class="input-xxlarge" placeholder="3782,1351,1423,1374" />
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">topic_set_2</label>
      <div class="controls">
        <Input @value={{this.topic_set_2}} class="input-xxlarge" placeholder="optional" />
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">topic_set_3</label>
      <div class="controls">
        <Input @value={{this.topic_set_3}} class="input-xxlarge" placeholder="optional" />
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">send_at (optional)</label>
      <div class="controls">
        <Input @value={{this.send_at}} @type="datetime-local" class="input-large" />
        <div class="help-block">
          If set, queued rows won’t send until this time.
        </div>
      </div>
    </div>

    <div class="control-group">
      <label class="control-label">test_email (optional)</label>
      <div class="controls">
        <Input @value={{this.test_email}} class="input-xlarge" placeholder="you@domain.com" />
        <div class="help-block">
          You can send a draft test (no save) or send one after create.
        </div>

        <div style="margin-top:6px;">
          <button class="btn" {{on "click" this.testDraft}} disabled={{this.busy}}>
            Send draft test (no save)
          </button>
        </div>
      </div>
    </div>

    <div class="controls">
      <button class="btn btn-primary" {{on "click" this.createCampaign}} disabled={{this.busy}}>
        Create + Populate Queue
      </button>
    </div>
  </div>

  <hr>

  <h2>Existing Campaigns</h2>

  <div style="margin: 8px 0;">
    <button class="btn" {{on "click" this.prevPage}} disabled={{or this.busy (lte this.meta.page 1)}}>
      ◀ Prev
    </button>
    <button class="btn" {{on "click" this.nextPage}} disabled={{or this.busy (gte this.meta.page this.meta.total_pages)}}>
      Next ▶
    </button>
    <span style="margin-left:10px;">
      Page <strong>{{this.meta.page}}</strong> / {{this.meta.total_pages}} (total {{this.meta.total}})
    </span>
  </div>

  {{#if this.campaigns.length}}
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Key</th>
          <th>Enabled</th>
          <th>send_at</th>
          <th>Queued</th>
          <th>Processing</th>
          <th>Sent</th>
          <th>Failed</th>
          <th>Skipped</th>
          <th>Actions</th>
        </tr>
      </thead>

      <tbody>
        {{#each this.campaigns as |c|}}
          <tr>
            <td>{{c.id}}</td>
            <td><code>{{c.campaign_key}}</code></td>
            <td>{{c.enabled}}</td>
            <td>{{c.send_at}}</td>
            <td>{{c.queued_count}}</td>
            <td>{{c.processing_count}}</td>
            <td>{{c.sent_count}}</td>
            <td>{{c.failed_count}}</td>
            <td>{{c.skipped_unsubscribed_count}}</td>
            <td>
              {{#if c.enabled}}
                <button class="btn" {{on "click" (fn this.disableCampaign c.id)}} disabled={{this.busy}}>Disable</button>
              {{else}}
                <button class="btn btn-primary" {{on "click" (fn this.enableCampaign c.id)}} disabled={{this.busy}}>Enable</button>
              {{/if}}

              <button class="btn btn-danger" {{on "click" (fn this.deleteCampaign c.id)}} disabled={{this.busy}}>
                Delete
              </button>

              <button class="btn" {{on "click" (fn this.toggleSql c.id)}} disabled={{this.busy}}>
                {{if (get this.showSqlById c.id) "Hide Query" "Show Query"}}
              </button>

              <div style="margin-top:6px;">
                <input
                  class="input-medium"
                  placeholder="test email"
                  value={{get this.testEmailById c.id}}
                  {{on "input" (fn this.onTestEmailInput c.id)}}
                />
                <button class="btn" {{on "click" (fn this.testSend c.id)}} disabled={{this.busy}}>
                  Test Send
                </button>
              </div>
            </td>
          </tr>

          {{#if (get this.showSqlById c.id)}}
            <tr>
              <td colspan="10">
                <div class="well">
                  <div style="margin-bottom:10px;">
                  <div style="margin-bottom:6px;"><strong>topic_sets</strong></div>
                  <pre style="white-space: pre-wrap;">{{this.formatTopicSets c.topic_sets}}</pre>
                </div>

                <div style="margin-bottom:6px;"><strong>selection_sql</strong></div>
                  <pre style="white-space: pre-wrap;">{{c.selection_sql}}</pre>
                </div>
              </td>
            </tr>
          {{/if}}

          {{#if c.last_error}}
            <tr>
              <td colspan="10">
                <div class="alert alert-error">
                  <strong>Last error:</strong> {{c.last_error}}
                </div>
              </td>
            </tr>
          {{/if}}
        {{/each}}
      </tbody>
    </table>

    <div style="margin: 8px 0;">
      <button class="btn" {{on "click" this.prevPage}} disabled={{or this.busy (lte this.meta.page 1)}}>
        ◀ Prev
      </button>
      <button class="btn" {{on "click" this.nextPage}} disabled={{or this.busy (gte this.meta.page this.meta.total_pages)}}>
        Next ▶
      </button>
      <span style="margin-left:10px;">
        Page <strong>{{this.meta.page}}</strong> / {{this.meta.total_pages}} (total {{this.meta.total}})
      </span>
    </div>
  {{else}}
    <p>No campaigns yet.</p>
  {{/if}}
</section>
